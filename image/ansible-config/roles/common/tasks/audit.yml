---
- name: Capture live config without writing
  ansible.builtin.import_tasks: backup.yml
  vars:
    backup_write: false

- name: Check for desired config file
  ansible.builtin.stat:
    path: "{{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"
  delegate_to: localhost
  register: desired_stat

- name: Ensure desired config exists
  ansible.builtin.assert:
    that:
      - desired_stat.stat.exists
    fail_msg: "Missing desired config at {{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"

- name: Read desired config from Git
  ansible.builtin.slurp:
    src: "{{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"
  delegate_to: localhost
  register: desired_blob

- name: Decode desired config
  ansible.builtin.set_fact:
    desired_config: "{{ desired_blob.content | b64decode }}"

- name: Normalize desired config
  ansible.builtin.set_fact:
    desired_config: "{{ desired_config | string | regex_replace('\\r', '') }}"

- name: Strip volatile lines from desired config
  ansible.builtin.set_fact:
    desired_config: "{{ desired_config | regex_replace('(?m)' ~ item ~ '\\n?', '') }}"
  loop: "{{ normalize_patterns | default([]) }}"

- name: Collapse excessive blank lines in desired config
  ansible.builtin.set_fact:
    desired_config: "{{ desired_config | regex_replace('\\n{3,}', '\\n\\n') }}"
  when: normalize_strip_empty | default(true)

- name: Compare desired and live configs
  ansible.builtin.set_fact:
    drift_detected: "{{ (normalized_config | trim) != (desired_config | trim) }}"

- name: Report drift summary
  ansible.builtin.debug:
    msg: "Config drift detected for {{ inventory_hostname }}."
  when: drift_detected

- name: Report clean audit
  ansible.builtin.debug:
    msg: "No drift detected for {{ inventory_hostname }}."
  when: not drift_detected

- name: Create temp files for diff
  ansible.builtin.tempfile:
    state: file
    suffix: ".desired.conf"
  delegate_to: localhost
  register: desired_tmp
  check_mode: false
  when: drift_detected and (audit_show_diff | default(true))

- name: Create temp file for live config
  ansible.builtin.tempfile:
    state: file
    suffix: ".live.conf"
  delegate_to: localhost
  register: live_tmp
  check_mode: false
  when: drift_detected and (audit_show_diff | default(true))

- name: Write desired config to temp file
  ansible.builtin.copy:
    dest: "{{ desired_tmp.path }}"
    content: "{{ desired_config | trim }}\n"
  delegate_to: localhost
  check_mode: false
  when: drift_detected and (audit_show_diff | default(true))

- name: Write live config to temp file
  ansible.builtin.copy:
    dest: "{{ live_tmp.path }}"
    content: "{{ normalized_config | trim }}\n"
  delegate_to: localhost
  check_mode: false
  when: drift_detected and (audit_show_diff | default(true))

- name: Diff desired vs live config
  ansible.builtin.command: "diff -u {{ desired_tmp.path }} {{ live_tmp.path }}"
  delegate_to: localhost
  register: diff_result
  changed_when: false
  failed_when: false
  check_mode: false
  when: drift_detected and (audit_show_diff | default(true))

- name: Show drift diff
  ansible.builtin.debug:
    msg: "{{ diff_result.stdout }}"
  when: drift_detected and (audit_show_diff | default(true))

- name: Clean up temp files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  delegate_to: localhost
  loop: "{{ [desired_tmp.path | default(''), live_tmp.path | default('')] | reject('equalto','') | list }}"
  check_mode: false
  when: drift_detected and (audit_show_diff | default(true)) and (audit_cleanup_temp | default(true))

- name: Fail when drift is detected
  ansible.builtin.fail:
    msg: "Config drift detected for {{ inventory_hostname }}. Review the diff output."
  when: drift_detected and (audit_fail_on_drift | default(true))
