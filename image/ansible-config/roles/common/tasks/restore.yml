---
- name: Apply kind defaults
  ansible.builtin.import_tasks: load_kind_defaults.yml

- name: Validate backup transport
  ansible.builtin.assert:
    that:
      - backup_transport in ['cli', 'netconf', 'httpapi', 'scp']
    fail_msg: "backup_transport must be one of: cli, netconf, httpapi, scp"

- name: Validate HTTP API restore settings
  ansible.builtin.assert:
    that:
      - httpapi_base_url | length > 0
      - httpapi_restore_path | length > 0
    fail_msg: "httpapi_base_url and httpapi_restore_path must be set for HTTP API restores"
  when: backup_transport == 'httpapi'

- name: Validate SCP restore settings
  ansible.builtin.assert:
    that:
      - (scp_restore_path | default('') | length > 0) or (scp_remote_path | default('') | length > 0)
    fail_msg: "scp_restore_path or scp_remote_path must be set for SCP restores"
  when: backup_transport == 'scp'

- name: Check for desired config file
  ansible.builtin.stat:
    path: "{{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"
  delegate_to: localhost
  register: desired_stat

- name: Ensure desired config exists
  ansible.builtin.assert:
    that:
      - desired_stat.stat.exists
    fail_msg: "Missing desired config at {{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"

- name: Read desired config
  ansible.builtin.slurp:
    src: "{{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"
  delegate_to: localhost
  register: desired_blob

- name: Decode desired config
  ansible.builtin.set_fact:
    desired_config: "{{ desired_blob.content | b64decode }}"

- name: Ensure desired config is not empty
  ansible.builtin.assert:
    that:
      - desired_config | length > 0
    fail_msg: "Desired config file is empty. Restore aborted."

- name: Apply config via CLI
  ansible.builtin.include_tasks: restore_cli.yml
  when: backup_transport == 'cli'

- name: Apply config via NETCONF
  ansible.builtin.include_tasks: restore_netconf.yml
  when: backup_transport == 'netconf'

- name: Apply config via HTTP API
  ansible.builtin.include_tasks: restore_httpapi.yml
  when: backup_transport == 'httpapi'

- name: Apply config via SCP
  ansible.builtin.include_tasks: restore_scp.yml
  when: backup_transport == 'scp'

- name: Verify post-restore state via audit
  ansible.builtin.import_role:
    name: common
    tasks_from: audit
  vars:
    audit_fail_on_drift: "{{ not ansible_check_mode }}"
  when: restore_verify | default(true)
