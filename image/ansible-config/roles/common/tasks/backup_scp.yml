---
- name: Resolve SCP settings
  ansible.builtin.set_fact:
    _scp_user: "{{ scp_username | default(ansible_user, true) | default('') }}"
    _scp_pass: "{{ scp_password | default(ansible_password, true) | default('') }}"
    _scp_key: "{{ scp_private_key | default(ansible_ssh_private_key_file, true) | default('') }}"
    _scp_port: "{{ scp_port | default(22) }}"
    _scp_extra_args: "{{ (scp_extra_args | default('') | trim).split() }}"
    _scp_src: "{{ scp_backup_path | default(scp_remote_path, true) }}"

- name: Ensure SCP username is set
  ansible.builtin.assert:
    that:
      - _scp_user | length > 0
    fail_msg: "scp_username (or ansible_user) must be set for SCP backups"

- name: Create temp file for SCP download
  ansible.builtin.tempfile:
    state: file
    suffix: ".conf"
  register: scp_tmp
  delegate_to: localhost
  check_mode: false

- name: Build SCP command arguments
  ansible.builtin.set_fact:
    _scp_base_args: >-
      {{
        ['scp', '-P', _scp_port | string]
        + _scp_extra_args
        + (['-i', _scp_key] if (_scp_key | length > 0) else [])
      }}
    _scp_src_arg: "{{ _scp_user }}@{{ ansible_host }}:{{ _scp_src }}"

- name: Fetch config via SCP (password)
  ansible.builtin.command:
    argv: "{{ ['sshpass', '-p', _scp_pass] + _scp_base_args + [_scp_src_arg, scp_tmp.path] }}"
  delegate_to: localhost
  check_mode: false
  changed_when: false
  no_log: "{{ scp_no_log | default(true) }}"
  when: _scp_pass | length > 0

- name: Fetch config via SCP (key/agent)
  ansible.builtin.command:
    argv: "{{ _scp_base_args + [_scp_src_arg, scp_tmp.path] }}"
  delegate_to: localhost
  check_mode: false
  changed_when: false
  when: _scp_pass | length == 0

- name: Read SCP payload
  ansible.builtin.slurp:
    src: "{{ scp_tmp.path }}"
  delegate_to: localhost
  register: scp_blob

- name: Set raw config from SCP payload
  ansible.builtin.set_fact:
    raw_config: "{{ scp_blob.content | b64decode }}"

- name: Clean up temp file
  ansible.builtin.file:
    path: "{{ scp_tmp.path }}"
    state: absent
  delegate_to: localhost
