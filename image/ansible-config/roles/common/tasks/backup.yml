---
- name: Validate backup transport
  ansible.builtin.assert:
    that:
      - backup_transport in ['cli', 'netconf', 'httpapi']
    fail_msg: "backup_transport must be one of: cli, netconf, httpapi"

- name: Validate CLI backup command
  ansible.builtin.assert:
    that:
      - backup_command | length > 0
    fail_msg: "backup_command must be set for CLI backups"
  when: backup_transport == 'cli'

- name: Validate HTTP API backup settings
  ansible.builtin.assert:
    that:
      - httpapi_base_url | length > 0
      - httpapi_backup_path | length > 0
    fail_msg: "httpapi_base_url and httpapi_backup_path must be set for HTTP API backups"
  when: backup_transport == 'httpapi'

- name: Collect running config via CLI
  ansible.builtin.include_tasks: backup_cli.yml
  when: backup_transport == 'cli'

- name: Collect running config via NETCONF
  ansible.builtin.include_tasks: backup_netconf.yml
  when: backup_transport == 'netconf'

- name: Ensure kind-specific HTTP API backup task is selected
  ansible.builtin.assert:
    that:
      - clab_kind | default('') | length > 0
    fail_msg: "clab_kind not resolved; set clab_kind_credentials key matching a group in inventory."
  when: backup_transport == 'httpapi'

- name: Check kind-specific HTTP API backup task
  ansible.builtin.stat:
    path: "{{ role_path }}/tasks/kinds/{{ clab_kind }}/backup_httpapi.yml"
  register: httpapi_backup_task_stat
  when: backup_transport == 'httpapi'

- name: Ensure HTTP API backup task file exists
  ansible.builtin.assert:
    that:
      - httpapi_backup_task_stat.stat.exists
    fail_msg: "Missing HTTP API backup task for kind '{{ clab_kind }}' at tasks/kinds/{{ clab_kind }}/backup_httpapi.yml"
  when: backup_transport == 'httpapi'

- name: Collect running config via HTTP API
  ansible.builtin.include_tasks: "kinds/{{ clab_kind }}/backup_httpapi.yml"
  when: backup_transport == 'httpapi'

- name: Ensure a config payload was collected
  ansible.builtin.assert:
    that:
      - raw_config is defined
      - raw_config | length > 0
    fail_msg: "No configuration data was collected from the device."

- name: Normalize raw config
  ansible.builtin.set_fact:
    normalized_config: "{{ raw_config | string | regex_replace('\\r', '') }}"

- name: Strip volatile lines
  ansible.builtin.set_fact:
    normalized_config: "{{ normalized_config | regex_replace('(?m)' ~ item ~ '\\n?', '') }}"
  loop: "{{ normalize_patterns | default([]) }}"

- name: Collapse excessive blank lines
  ansible.builtin.set_fact:
    normalized_config: "{{ normalized_config | regex_replace('\\n{3,}', '\\n\\n') }}"
  when: normalize_strip_empty | default(true)

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ backup_root }}/{{ inventory_hostname }}"
    state: directory
    mode: "0750"
  delegate_to: localhost
  when: backup_write | default(true)

- name: Write running config to backups directory
  ansible.builtin.copy:
    dest: "{{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"
    content: "{{ normalized_config | trim }}\n"
    mode: "0640"
  delegate_to: localhost
  when: backup_write | default(true)
