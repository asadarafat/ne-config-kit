---
- name: Resolve SCP settings
  ansible.builtin.set_fact:
    _scp_user: "{{ scp_username | default(ansible_user, true) | default('') }}"
    _scp_pass: "{{ scp_password | default(ansible_password, true) | default('') }}"
    _scp_key: "{{ scp_private_key | default(ansible_ssh_private_key_file, true) | default('') }}"
    _scp_port: "{{ scp_port | default(22) }}"
    _scp_extra_args: "{{ (scp_extra_args | default('') | trim).split() }}"
    _scp_dst: "{{ scp_restore_path | default(scp_remote_path, true) }}"

- name: Ensure SCP username is set
  ansible.builtin.assert:
    that:
      - _scp_user | length > 0
    fail_msg: "scp_username (or ansible_user) must be set for SCP restores"

- name: Build SCP command arguments
  ansible.builtin.set_fact:
    _scp_base_args: >-
      {{
        ['scp', '-P', _scp_port | string]
        + _scp_extra_args
        + (['-i', _scp_key] if (_scp_key | length > 0) else [])
      }}
    _scp_dst_arg: "{{ _scp_user }}@{{ ansible_host }}:{{ _scp_dst }}"

- name: Push config via SCP (password)
  ansible.builtin.command:
    argv: >-
      {{
        ['sshpass', '-p', _scp_pass]
        + _scp_base_args
        + [backup_root ~ '/' ~ inventory_hostname ~ '/' ~ backup_filename, _scp_dst_arg]
      }}
  delegate_to: localhost
  no_log: "{{ scp_no_log | default(true) }}"
  when:
    - _scp_pass | length > 0
    - not ansible_check_mode

- name: Push config via SCP (key/agent)
  ansible.builtin.command:
    argv: >-
      {{
        _scp_base_args
        + [backup_root ~ '/' ~ inventory_hostname ~ '/' ~ backup_filename, _scp_dst_arg]
      }}
  delegate_to: localhost
  when:
    - _scp_pass | length == 0
    - not ansible_check_mode
