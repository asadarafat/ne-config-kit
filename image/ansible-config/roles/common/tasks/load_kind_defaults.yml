- name: Infer clab_kind from inventory when missing
  ansible.builtin.set_fact:
    clab_kind: "{{ _derived_clab_kind }}"
  vars:
    _kind_candidates: >-
      {{
        (clab_kind_credentials | default({}) | dict2items | map(attribute='key') | list)
        | reject('equalto', 'all')
        | reject('equalto', 'routers')
        | list
      }}
    _baked_kind_files: >-
      {{
        lookup('ansible.builtin.fileglob', playbook_dir ~ '/../group_vars/*.yml', wantlist=True)
        | map('basename')
        | map('regex_replace', '\\.yml$', '')
        | reject('equalto', 'all')
        | reject('equalto', 'routers')
        | list
      }}
    _inventory_kinds: "{{ group_names | default([]) }}"
    _derived_clab_kind: >-
      {{
        (_kind_candidates | intersect(_inventory_kinds) | first)
        | default((_baked_kind_files | intersect(_inventory_kinds) | first) | default(''))
      }}
  when: clab_kind is not defined or (clab_kind | string | length == 0)

- name: Load kind defaults from baked workspace
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/{{ clab_kind }}.yml"
    name: clab_kind_defaults
  when: clab_kind is defined and (clab_kind | string | length > 0)
  ignore_errors: true

- name: Apply kind connection defaults early (network os)
  ansible.builtin.set_fact:
    ansible_network_os: "{{ clab_kind_defaults.ansible_network_os }}"
  when:
    - clab_kind_defaults is defined
    - clab_kind_defaults.ansible_network_os is defined
    - ansible_network_os is not defined

- name: Apply kind connection defaults early (connection)
  ansible.builtin.set_fact:
    ansible_connection: "{{ clab_kind_defaults.ansible_connection }}"
  when:
    - clab_kind_defaults is defined
    - clab_kind_defaults.ansible_connection is defined
    - ansible_connection is not defined or ansible_connection in ['ssh', 'paramiko', 'smart']

- name: Apply kind defaults for missing settings
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ (clab_kind_defaults | default({})) | dict2items }}"
  when:
    - clab_kind_defaults is defined
    - vars[item.key] is not defined
    - item.key not in ['ansible_connection', 'ansible_network_os']
    - item.value is not string or (item.value | regex_search('^__omit_place_holder__')) is none
    - (item.key | regex_search('^audit_')) is none
    - item.key != 'restore_verify'

- name: Load global defaults from baked workspace
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/routers/defaults.yml"
    name: clab_router_defaults
  ignore_errors: true

- name: Apply global defaults for missing settings
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ (clab_router_defaults | default({})) | dict2items }}"
  when:
    - clab_router_defaults is defined
    - vars[item.key] is not defined
    - item.value is not string or (item.value | regex_search('^__omit_place_holder__')) is none
    - (item.key | regex_search('^audit_')) is none
    - item.key != 'restore_verify'
