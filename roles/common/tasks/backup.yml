---
- name: Validate backup transport
  ansible.builtin.assert:
    that:
      - backup_transport in ['cli', 'netconf', 'httpapi']
    fail_msg: "backup_transport must be one of: cli, netconf, httpapi"

- name: Validate CLI backup command
  ansible.builtin.assert:
    that:
      - backup_command | length > 0
    fail_msg: "backup_command must be set for CLI backups"
  when: backup_transport == 'cli'

- name: Validate HTTP API backup settings
  ansible.builtin.assert:
    that:
      - httpapi_base_url | length > 0
      - httpapi_backup_path | length > 0
    fail_msg: "httpapi_base_url and httpapi_backup_path must be set for HTTP API backups"
  when: backup_transport == 'httpapi'

- name: Collect running config via CLI
  ansible.netcommon.cli_command:
    command: "{{ backup_command }}"
  register: cli_result
  when: backup_transport == 'cli'

- name: Collect running config via NETCONF
  ansible.netcommon.netconf_get:
    source: "{{ netconf_source }}"
    filter: "{{ netconf_filter | default(omit, true) }}"
  register: netconf_result
  when: backup_transport == 'netconf'

- name: Collect running config via HTTP API
  ansible.builtin.uri:
    url: "{{ httpapi_base_url }}{{ httpapi_backup_path }}"
    method: "{{ httpapi_backup_method }}"
    user: "{{ httpapi_username | default(ansible_user, true) | default(omit, true) }}"
    password: "{{ httpapi_password | default(ansible_password, true) | default(omit, true) }}"
    headers: "{{ httpapi_headers | default(omit) }}"
    validate_certs: "{{ httpapi_validate_certs }}"
    force_basic_auth: "{{ httpapi_force_basic_auth }}"
    body: "{{ httpapi_backup_body | default(omit, true) }}"
    body_format: "{{ httpapi_backup_body_format | default(httpapi_body_format, true) | default(omit, true) }}"
    status_code: "{{ httpapi_backup_expected_status | default(httpapi_expected_status, true) | default(omit, true) }}"
    return_content: true
  register: httpapi_result
  delegate_to: localhost
  when: backup_transport == 'httpapi'

- name: Set raw config from CLI output
  ansible.builtin.set_fact:
    raw_config: >-
      {{
        (cli_result.stdout | first)
        if (cli_result.stdout is iterable and (cli_result.stdout is not string))
        else cli_result.stdout
      }}
  when: backup_transport == 'cli'

- name: Set raw config from NETCONF output
  ansible.builtin.set_fact:
    raw_config: >-
      {{
        (netconf_result.stdout | first)
        if (netconf_result.stdout is iterable and (netconf_result.stdout is not string))
        else (netconf_result.stdout | default(netconf_result.rpc_reply))
      }}
  when: backup_transport == 'netconf'

- name: Capture HTTP API payload
  ansible.builtin.set_fact:
    httpapi_payload: >-
      {{
        httpapi_result.json
        if (httpapi_response_format == 'json' and httpapi_result.json is defined)
        else httpapi_result.content
      }}
  when: backup_transport == 'httpapi'

- name: Set raw config from HTTP API output
  ansible.builtin.set_fact:
    raw_config: >-
      {{
        (httpapi_payload | json_query(httpapi_response_jmespath))
        if (httpapi_response_format == 'json' and httpapi_response_jmespath is defined and httpapi_response_jmespath)
        else (
          (httpapi_payload | to_nice_json) if (httpapi_response_format == 'json')
          else (httpapi_payload | string)
        )
      }}
  when: backup_transport == 'httpapi'

- name: Ensure a config payload was collected
  ansible.builtin.assert:
    that:
      - raw_config is defined
      - raw_config | length > 0
    fail_msg: "No configuration data was collected from the device."

- name: Normalize raw config
  ansible.builtin.set_fact:
    normalized_config: "{{ raw_config | string | regex_replace('\\r', '') }}"

- name: Strip volatile lines
  ansible.builtin.set_fact:
    normalized_config: "{{ normalized_config | regex_replace('(?m)' ~ item ~ '\\n?', '') }}"
  loop: "{{ normalize_patterns | default([]) }}"

- name: Collapse excessive blank lines
  ansible.builtin.set_fact:
    normalized_config: "{{ normalized_config | regex_replace('\\n{3,}', '\\n\\n') }}"
  when: normalize_strip_empty | default(true)

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ backup_root }}/{{ inventory_hostname }}"
    state: directory
    mode: "0750"
  delegate_to: localhost
  when: backup_write | default(true)

- name: Write running config to backups directory
  ansible.builtin.copy:
    dest: "{{ backup_root }}/{{ inventory_hostname }}/{{ backup_filename }}"
    content: "{{ normalized_config | trim }}\n"
    mode: "0640"
  delegate_to: localhost
  when: backup_write | default(true)
